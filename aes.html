<html>
    <head> 
        <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/core-min.js"></script>
        <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
        <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/pbkdf2.js"></script>
        <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
    </head>

    <body>

        <h2> Decrypt files encrypted with OpenSSL AES-256-CBC with
            PBKDF2 key derivation </h2>

        <div class="row">
            <div class="span3 offset2">
                Choose file
            </div>
            <div class="span3" id="upload_file_container">
                <input type="file" id="files" name="file" />  
            </div>
        </div>
        <div class="row">
            <div class="span3 offset2">
                Enter password
            </div>
            <div class="span3">
                <input type="password" id="passwordfield" name="passwordfield" alt="pass" />
            </div>
        </div>

        <div class="row">
            <div class="span4 offset5">
                <span class="readBytesButtons"> 
                    <button>Read and decrypt file</button> 
                </span>
            </div>
        </div>

        <div class="row">
            <div class="span2"> File contents: </div>

            <div class="well">
                <div class="span8 offset2">
                    <div id="byte_range"></div>
                    <div id="byte_content"></div>
                    <div class="" id="mydata"></div>
                    <div style="display: none" id="mydata-hidden"></div>
                </div>
            </div>
        </div>



    </div>
</div>



<script>

    function arraybuffer2WordArray(arraybuffer)
    {
        var words = [],
        u8arr = new Uint8Array(arraybuffer),
        len = u8arr.length;
        console.log("length = " + len);

        for (var i = 0; i < len; i++) {
            words[i >>> 2] |= (u8arr[i] & 0xff) << (24 - (i % 4) * 8);
        }

        return CryptoJS.lib.WordArray.create(words, len);
    }

    function readRest(password) {
        var files = document.getElementById('files').files;
        if (!files.length) {
            alert('Please select a file!');
            return;
        }

        var file = files[0];
        // check for magic string at head
        var magic_str = "YCRANDOMFILE";
        //var read_start_byte = 0;
        var read_start_byte = magic_str.length;
        var read_end_byte = file.size;

        // Compute pbkdf2
        var keysize_words = 256/32;
        var salt = 'ssssssss';
        // var password = 'fundamental mechanism pace sure';
        var key = CryptoJS.PBKDF2(password, salt, { keySize: keysize_words, iterations: 5});
        var ivarr = [];
        for (var i = 0; i < keysize_words; i += 4) {
            ivarr.push(0);
        }
        var iv = CryptoJS.lib.WordArray.create(ivarr, keysize_words);

        // console.log("Key: " + CryptoJS.enc.Hex.stringify(key));

        var reader = new FileReader();

        reader.onloadend = function(evt) {
            if (evt.target.readyState == FileReader.DONE) { // DONE == 2
                var wordarray = arraybuffer2WordArray(evt.target.result);
                //var base64 = CryptoJS.enc.Base64.stringify(wordarray);
                //console.log("base64: " + base64);
                var encrypted = CryptoJS.lib.CipherParams.create({ ciphertext: wordarray });
                //read_data = read_data.replace(/(\r\n|\n|\r)/gm,""); // clean newlines
                // var decrypted = CryptoJS.AES.decrypt(evt.target.result, key);
                var decrypted = CryptoJS.AES.decrypt(encrypted, key, { iv: iv });
                document.getElementById('byte_content').textContent = 
                CryptoJS.enc.Utf8.stringify(decrypted);
                console.log("dec: " + decrypted);
            }
        };

        var blob = file.slice(read_start_byte, read_end_byte);
        reader.readAsArrayBuffer(blob);
    }

    function readHeader() {

        var password = document.getElementById("passwordfield").value;
        //alert("Got pass " + password);

        var files = document.getElementById('files').files;
        if (!files.length) {
            alert('Please select a file!');
            return;
        }

        var file = files[0];
        var start = 0;
        // check for magic string at head
        var magic_str = "YCRANDOMFILE";
        var magic_end_byte = magic_str.length;
        var reader_magic = new FileReader();

        // If we use onloadend, we need to check the readyState.
        reader_magic.onloadend = function(evt) {
            if (evt.target.readyState == FileReader.DONE) { // DONE == 2
                /*
                document.getElementById('byte_content').textContent = evt.target.result;
                document.getElementById('byte_range').textContent = 
                ['Read bytes: ', start + 1, ' - ', stop + 1,
                ' of ', file.size, ' byte file'].join('');
                */
                if (evt.target.result === magic_str) {
                    readRest(password);
                }
            }
        };

        var blob = file.slice(0, magic_end_byte);
        reader_magic.readAsBinaryString(blob);
    }

    document.querySelector('.readBytesButtons').addEventListener('click', function(evt) {
        if (evt.target.tagName.toLowerCase() == 'button') {
            readHeader();
        }
    }, false);
</script>


<br/>
<br/>
<br/>

</body>


</html>

